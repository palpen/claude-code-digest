#!/bin/bash

REPO="anthropics/claude-code"
DAYS_AGO="${1:-7}"
OUTPUT_DIR="${2:-$HOME/Desktop}"
OUTPUT_FILE="$OUTPUT_DIR/claude-code-weekly-digest-$(date +%Y-%m-%d).md"

if [[ "$OSTYPE" == "darwin"* ]]; then
    SINCE_DATE=$(date -v-${DAYS_AGO}d +%Y-%m-%d)
else
    SINCE_DATE=$(date -d "${DAYS_AGO} days ago" +%Y-%m-%d)
fi

echo "Fetching closed issues from $REPO since $SINCE_DATE ($DAYS_AGO days)..."

cat > "$OUTPUT_FILE" << EOF
# Claude Code Weekly Digest
**Generated:** $(date +"%Y-%m-%d %H:%M")
**Period:** $SINCE_DATE to $(date +%Y-%m-%d) ($DAYS_AGO days)
**Repository:** [$REPO](https://github.com/$REPO)

---

EOF

echo "### High Priority"
high_priority=$(gh issue list --repo "$REPO" \
    --state closed \
    --search "closed:>=$SINCE_DATE label:priority:high" \
    --limit 50 \
    --json number,title,labels,closedAt)

if [ "$(echo "$high_priority" | jq 'length')" -gt 0 ]; then
    echo "## ðŸ”´ High Priority" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "$high_priority" | jq -r 'sort_by(.closedAt) | reverse | .[] | "- [#\(.number)](https://github.com/'$REPO'/issues/\(.number)) \(.title)  \n  _Closed: \(.closedAt | split("T")[0])_ | Labels: \(.labels | map(.name) | join(", "))\n"' >> "$OUTPUT_FILE"
fi

echo "### New Features (Enhancements)"
enhancements=$(gh issue list --repo "$REPO" \
    --state closed \
    --search "closed:>=$SINCE_DATE label:enhancement" \
    --limit 50 \
    --json number,title,labels,closedAt)

if [ "$(echo "$enhancements" | jq 'length')" -gt 0 ]; then
    echo "## âœ¨ New Features (Enhancements)" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "$enhancements" | jq -r 'sort_by(.closedAt) | reverse | .[] | "- [#\(.number)](https://github.com/'$REPO'/issues/\(.number)) \(.title)  \n  _Closed: \(.closedAt | split("T")[0])_ | Labels: \(.labels | map(.name) | join(", "))\n"' >> "$OUTPUT_FILE"
fi

echo "### Bug Fixes"
bugs=$(gh issue list --repo "$REPO" \
    --state closed \
    --search "closed:>=$SINCE_DATE label:bug -label:invalid -label:duplicate" \
    --limit 50 \
    --json number,title,labels,closedAt)

if [ "$(echo "$bugs" | jq 'length')" -gt 0 ]; then
    echo "## ðŸ› Bug Fixes" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "$bugs" | jq -r 'sort_by(.closedAt) | reverse | .[] | "- [#\(.number)](https://github.com/'$REPO'/issues/\(.number)) \(.title)  \n  _Closed: \(.closedAt | split("T")[0])_ | Labels: \(.labels | map(.name) | join(", "))\n"' >> "$OUTPUT_FILE"
fi

echo "### Other Closed Issues"
other=$(gh issue list --repo "$REPO" \
    --state closed \
    --search "closed:>=$SINCE_DATE -label:enhancement -label:bug -label:invalid -label:duplicate -label:wontfix -label:\"not planned\"" \
    --limit 50 \
    --json number,title,labels,closedAt)

if [ "$(echo "$other" | jq 'length')" -gt 0 ]; then
    echo "## ðŸ“‹ Other Closed Issues" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "$other" | jq -r 'sort_by(.closedAt) | reverse | .[] | "- [#\(.number)](https://github.com/'$REPO'/issues/\(.number)) \(.title)  \n  _Closed: \(.closedAt | split("T")[0])_ | Labels: \(.labels | map(.name) | join(", "))\n"' >> "$OUTPUT_FILE"
fi

cat >> "$OUTPUT_FILE" << EOF
---
_Generated by [claude-code-digest](https://github.com/palpen/claude-code-digest)_
EOF

echo ""
echo "Digest saved to: $OUTPUT_FILE"
echo ""
echo "Quick stats:"
gh issue list --repo "$REPO" --state closed --search "closed:>=$SINCE_DATE" --limit 200 --json number | jq 'length' | xargs -I {} echo "  Total closed issues: {}"
